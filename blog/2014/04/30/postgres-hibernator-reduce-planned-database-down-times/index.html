
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Postgres Hibernator: Reduce Planned Database Down Times - Postgres and other musings</title>
  <meta name="author" content="Gurjeet Singh">

  
  <meta name="description" content="TL;DR: Reduce planned database down times by about 97%, by using Postgres Hibernator. DBAs are often faced with the task of performing some &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://gurjeet.singh.im/blog/2014/04/30/postgres-hibernator-reduce-planned-database-down-times">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="Postgres and other musings" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3137805-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Postgres and other musings</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:gurjeet.singh.im/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Postgres Hibernator: Reduce Planned Database Down Times</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-30T17:23:57+00:00" pubdate data-updated="true">Apr 30<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><em>TL;DR</em>: Reduce planned database down times by about 97%, by using <a href="https://github.com/gurjeet/pg_hibernator">Postgres Hibernator</a>.</p>

<p>DBAs are often faced with the task of performing some maintenance on their database server(s) which requires shutting down the database. The maintenance may involve anything from a database minor-version upgrade, to a hardware upgrade. One ugly side-effect of restarting the database server/service is that all the data currently in database server&rsquo;s memory will be all lost, which was painstakingly fetched from disk and put there in response to application queries over time. And this data will have to be rebuilt as applications start querying database again. The query response times will be very high until all the &ldquo;hot&rdquo; data is fetched from disk and put back in memory again.</p>

<p>People employ a few tricks to get around this ugly truth, which range from running a <code>select * from app_table;</code>, to <code>dd if=table_file ...</code>, to using specialized utilities like <a href="https://github.com/klando/pgfincore">pgfincore</a> to prefetch data files into OS cache. Wouldn&rsquo;t it be ideal if the database itself could save and restore its memory contents across restarts!</p>

<p>The <a href="https://github.com/gurjeet/pg_hibernator">Postgres Hibernator</a> extension for <a href="http://www.postgresql.org">Postgres</a> performs the automatic save and restore of database buffers, integrated with database shutdown and startup, hence reducing the durations of database maintenance windows, in effect increasing the uptime of your applications.</p>

<p>Postgres Hibernator automatically saves the list of shared buffers to the disk on database shutdown, and automatically restores the buffers on database startup. This acts pretty much like your Operating System&rsquo;s hibernate feature, except, instead of saving the contents of the memory to disk, Postgres Hibernator saves just a list of block identifiers. And it uses that list after startup to restore the blocks from data directory into Postgres&#8217; <a href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-SHARED-BUFFERS">shared buffers</a>.</p>

<p>As explained in my <a href="http://gurjeet.singh.im/blog/2014/02/03/introducing-postgres-hibernator/">earlier post</a>, this extension is a set-it-and-forget-it solution, so, to get the benefits of this extension there&rsquo;s not much a DBA has to do, except install it.</p>

<p>Ideal database installations that would benefit from this extension would be the ones with a high cache-hit ratio. With Postgres Hibernator enabled, your database would start cranking pre-maintenance TPS (Transactions Per Second) within first couple of minutes after a restart.</p>

<p>As can be seen in the chart below, the database ramp-up time drops dramatically when Postgres Hibernator is enabled. The sooner the database TPS can reach the steady state, the faster your applications can start performing at full throttle.</p>

<p>The ramp-up time is even shorter if you wait for the Postgres Hibernator processes to end, before starting your applications.</p>

<h2>Sample Runs</h2>

<p><img src="/blog/../images/pg_hibernator_comparison.png" alt="Postgres Hibernator Comparison" />
<img src="/blog/../images/pg_hibernator_comparison_bars.png" alt="Postgres Hibernator Comparison Bars" /></p>

<p>As is quite evident, waiting for Postgres Hibernator to finish loading the data blocks before starting the application yeilds a 97% impprovement in database ramp-up time (2300 seconds to get to 122k TPS without Postgres Hibernator vs. 70 seconds).</p>

<h3>Details</h3>

<p>Please note that this is not a real benchmark, just something I developed to showcase this extension at its sweet spot.</p>

<p>The full source of this mini benchmark is available with the source code of the Postgres Hibernator, at its <a href="https://github.com/gurjeet/pg_hibernator">Git repo</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Hardware: MacBook Pro 9,1
</span><span class='line'>OS Distribution: Ubuntu 12.04 Desktop
</span><span class='line'>OS Kernel: Linux 3.11.0-19-generic
</span><span class='line'>RAM: 8 GB
</span><span class='line'>Physical CPU: 1
</span><span class='line'>CPU Count: 4
</span><span class='line'>Core Count: 8
</span><span class='line'>pgbench scale: 260 (~ 4 GB database)</span></code></pre></td></tr></table></div></figure>


<p>Before every test run, except the last (&lsquo;DB-only restart; No Hibernator&rsquo;), the Linux OS caches are dropped to simulate an OS restart.</p>

<p>In &lsquo;First Run&rsquo;, the Postgres Hibernator is enabled, but since this is the first ever run of the database, Postgres Hibernator doesn&rsquo;t kick in until shutdown, to save the buffer list.</p>

<p>In &lsquo;Hibernator w/ App&rsquo;, the application (pgbench) is started right after database restart. The Postgres Hibernator is restoring the data blocks to shared buffers while the application is also querying the database.</p>

<p>In the &lsquo;App after Hibernator&rsquo; case, the application is started <em>after</em> the Postgres Hibernator has finished reading database blocks. This took 70 seconds for reading the ~4 GB database.</p>

<p>In &lsquo;DB-only restart; No Hibernator` run, the OS caches are not dropped, but just the database service is restarted. This simulates database minor version upgrades, etc.</p>

<p>It&rsquo;s interesting to monitor the <code>bi</code> column in <code>vmstat 10</code> output, while these tests are running. In &lsquo;First Run&rsquo; and &lsquo;DB-only restart&rsquo; cases this column&rsquo;s values stayed between 2000 and 5000 until all data was in shared buffers, and then it dropped to zero (meaning that all data has been read from disk into shared buffers). In &lsquo;Hibernator w/ app&rsquo; case, this column&rsquo;s value ranges from 15,000 to 65,000, with an average around 25,000. it demonstrates that Postgres Hibernator&rsquo;s <code>Block Reader</code> process is aggressively reading the blocks from data directory into the shared buffers, but apparently not fast enough because the applicaion&rsquo;s queries are causing random reads from disk, which interfere with the sequential scans that Postgres Hibernator is trying to perform.</p>

<p>And finally, in &lsquo;App after Hibernator&rsquo; case, this column consistently shows values between 60,000 and 65,000, implying that in absence of simultaneous application load, the <code>Block Reader</code> can read data into shared buffers much faster.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Gurjeet Singh</span></span>

      








  


<time datetime="2014-04-30T17:23:57+00:00" pubdate data-updated="true">Apr 30<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/postgres/'>Postgres</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="/blog//twitter.com/share" class="twitter-share-button" data-url="http://gurjeet.singh.im/blog/2014/04/30/postgres-hibernator-reduce-planned-database-down-times/" data-via="singh_gurjeet" data-counturl="http://gurjeet.singh.im/blog/2014/04/30/postgres-hibernator-reduce-planned-database-down-times/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/02/23/google-maps-boston-plane-in-flight/" title="Previous Post: Google Maps Boston Plane in-flight">&laquo; Google Maps Boston Plane in-flight</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/07/23/announcing-tpc-c-dot-js-a-lightweight-implementation-of-tpc-c/" title="Next Post: Announcing TPC-C.js; A Lightweight Implementation of TPC-C">Announcing TPC-C.js; A Lightweight Implementation of TPC-C &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/23/announcing-tpc-c-dot-js-a-lightweight-implementation-of-tpc-c/">Announcing TPC-C.js; a Lightweight Implementation of TPC-C</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/30/postgres-hibernator-reduce-planned-database-down-times/">Postgres Hibernator: Reduce Planned Database Down Times</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/23/google-maps-boston-plane-in-flight/">Google Maps Boston Plane In-flight</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/03/introducing-postgres-hibernator/">Introducing Postgres Hibernator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/21/hibernating-and-restoring-postgres-buffer-cache/">Hibernating and Restoring Postgres Buffer Cache</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/gurjeet">@gurjeet</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/blog/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'gurjeet',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+GurjeetSinghK?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Gurjeet Singh -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'gurjeet-singh-im-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://gurjeet.singh.im/blog/2014/04/30/postgres-hibernator-reduce-planned-database-down-times/';
        var disqus_url = 'http://gurjeet.singh.im/blog/2014/04/30/postgres-hibernator-reduce-planned-database-down-times/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
